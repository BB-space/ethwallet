package com.zhgtrade.ethereum.wallet;

import com.alibaba.druid.util.StringUtils;
import com.zhgtrade.ethereum.wallet.model.Account;
import com.zhgtrade.ethereum.wallet.model.Token;
import com.zhgtrade.ethereum.wallet.utils.AccountUtils;
import com.zhgtrade.ethereum.wallet.utils.TokenUtils;
import com.zhgtrade.ethereum.wallet.utils.Web3jUtils;
import org.bouncycastle.util.encoders.Hex;
import org.web3j.crypto.TransactionEncoder;
import org.web3j.protocol.Web3j;
import org.web3j.protocol.core.DefaultBlockParameterName;
import org.web3j.protocol.core.methods.request.RawTransaction;
import org.web3j.protocol.core.methods.request.Transaction;
import org.web3j.protocol.core.methods.response.EthEstimateGas;
import org.web3j.protocol.core.methods.response.EthGetTransactionCount;
import org.web3j.tx.ManagedTransaction;
import org.web3j.tx.Transfer;
import org.web3j.utils.Convert;
import org.apache.log4j.Logger;

import java.math.BigInteger;
import java.util.List;
import java.util.concurrent.ExecutionException;

/**
 * 招股金服
 * CopyRight : www.zhgtrade.com
 * Author : 林超（362228416@qq.com）
 * Date： 2017-08-10 19:34
 */
public class AggregateAmountTask implements Runnable {

    private Logger log = Logger.getLogger(getClass().getName());

    public void sendTransactionGas(Token token) {
        if (AccountUtils.ETHER_TYPE.equals(token.getType())) {
            return;
        }

        try {
            log.info("send transaction gas to " + token.getName() + " address");
            List<Account> accounts = AccountUtils.listAccounts(token.getId().toString());
            Token ethToken = TokenUtils.getToken(AccountUtils.getDefaultIdentify());

            accounts.forEach(account -> {
                Double amount = Double.valueOf(account.getAmount());
                if (amount > token.getMinCount()) {
                    Web3j web3j = Web3jUtils.getWeb3j();
                    try {
                        EthGetTransactionCount ethGetTransactionCount = web3j.ethGetTransactionCount(token.getMainAccount(), DefaultBlockParameterName.PENDING).sendAsync().get();
                        BigInteger nonce = ethGetTransactionCount.getTransactionCount();
                        BigInteger gasPrice = web3j.ethGasPrice().sendAsync().get().getGasPrice();
                        Transaction mockTx = Transaction.createContractTransaction(account.getAddress(), nonce, gasPrice, "");
                        EthEstimateGas estimateGas = web3j.ethEstimateGas(mockTx).sendAsync().get();
                        BigInteger gas = estimateGas.getAmountUsed();
                        if(!StringUtils.isEmpty(token.getLimitGas()+"")){
                            gas = gas.add(new BigInteger(token.getLimitGas()+""));
                        }
                        BigInteger ethBalance = web3j.ethGetBalance(account.getAddress(), DefaultBlockParameterName.LATEST).sendAsync().get().getBalance();

                        BigInteger fee = gasPrice.multiply(gas);
                        if (ethBalance.compareTo(fee) == -1) {
                            BigInteger requireFee = fee.subtract(ethBalance);
                            String requireFeeStr = Convert.fromWei(requireFee.toString(), Convert.Unit.ETHER).toPlainString();
                            log.info("send transaction gas requireFee"+ requireFeeStr +" to " + token.getName() + " address");
                            AccountUtils.unLockAccount(ethToken.getMainAccount(), token.getMainPassword(), 30);
                            AccountUtils.sendTransaction(ethToken.getId() + "", account.getAddress(), requireFeeStr, "transaction gas fee");
                            AccountUtils.lockAccount(ethToken.getMainAccount());
                        }
                    } catch (Exception e) {
                        e.printStackTrace();
                    }
                }
            });
        } catch (Exception e) {
            e.printStackTrace();
        }
    }

    public void sendTransactionGas() {
        try {
            List<Token> tokens = TokenUtils.getTokens();
            tokens.forEach(token -> sendTransactionGas(token));
        } catch (Exception e) {
            e.printStackTrace();
        }
    }

    public void toMainWallet(Token token) {
        try {
            log.info("send transaction  " + token.getName() + " toMainWallet");
            List<Account> accounts = AccountUtils.listAccounts(token.getId().toString());
            Web3j web3j = Web3jUtils.getWeb3j();
            BigInteger gasPrice = web3j.ethGasPrice().sendAsync().get().getGasPrice();
            accounts.forEach(account -> {
                Double amount = Double.valueOf(account.getAmount());
                if (!account.getAddress().equals(token.getMainAccount()) && amount > token.getMinCount()) {
                    try {
                        log.info("send " + token.getName() + " transaction " + amount + " to mainAccoumt from " + account.getAddress());
                        AccountUtils.unLockAccount(account.getAddress(), token.getChildPassword(), 30);
                        if (AccountUtils.ETHER_TYPE.equals(token.getType())) {
                            // 以太坊
                            BigInteger leftAmount = Convert.toWei(amount.toString(), Convert.Unit.ETHER).toBigInteger().subtract(gasPrice.multiply(Transfer.GAS_LIMIT));
                            amount = Convert.fromWei(leftAmount.toString(), Convert.Unit.ETHER).doubleValue();
                            if (amount <= 0) {
                                log.info("eth amount less than fee");
                            } else {
                                AccountUtils.sendTransaction(token.getId().toString(), account.getAddress(), token.getMainAccount(), amount.toString(), null);
                            }
                        } else {
                            AccountUtils.sendTransaction(token.getId().toString(), account.getAddress(), token.getMainAccount(), amount.toString(), null);
                        }
                        AccountUtils.lockAccount(account.getAddress());
                    } catch (Exception e) {
                        e.printStackTrace();
                    }
                }
            });
        } catch (Exception e) {
            e.printStackTrace();
        }
    }

    public void toMainWallet() {
        try {
            List<Token> tokens = TokenUtils.getTokens();
            tokens.forEach(token -> toMainWallet(token));
        } catch (Exception e) {
            e.printStackTrace();
        }
    }

    @Override
    public void run() {
        for (;;) {
            sendTransactionGas();
            try {
                Thread.sleep(1000 * 60 * 5);
            } catch (Exception e) {
                e.printStackTrace();
            }
            toMainWallet();
            try {
                Thread.sleep(1000 * 60 * 5);
            } catch (Exception e) {
                e.printStackTrace();
            }
        }
    }

    public static void main(String[] args) throws ExecutionException, InterruptedException {
        Web3j web3j = Web3jUtils.getWeb3j();
        EthGetTransactionCount ethGetTransactionCount = web3j.ethGetTransactionCount("0xad489edb10a0f135e1cba6a3818029edaafe4a17", DefaultBlockParameterName.PENDING).sendAsync().get();
        BigInteger nonce = ethGetTransactionCount.getTransactionCount();
        BigInteger gasPrice = web3j.ethGasPrice().sendAsync().get().getGasPrice();
        Transaction mockTx = Transaction.createFunctionCallTransaction("0xad489edb10a0f135e1cba6a3818029edaafe4a17", nonce, gasPrice, null, "0xb485d02ec713cc0df5ecdcfaefaf0e8835a40dbf", Convert.toWei("500", Convert.Unit.GWEI).toBigInteger(), "0x6060604052601260065560408051908101604052600381527f44535400000000000000000000000000000000000000000000000000000000006020820152600790805162000052929160200190620000d2565b505b6a084595161401484a0000005b600160a060020a03331660009081526001602052604081208290558190555b5060048054600160a060020a03191633600160a060020a03169081179091557fce241d7ca1f669fee44b6fc00b8eba2df3bb514eed0f6f668f8f89096e81ed9460405160405180910390a25b6200017c565b828054600181600116156101000203166002900490600052602060002090601f016020900481019282601f106200011557805160ff191683800117855562000145565b8280016001018555821562000145579182015b828111156200014557825182559160200191906001019062000128565b5b506200015492915062000158565b5090565b6200017991905b808211156200015457600081556001016200015f565b5090565b90565b61127b806200018c6000396000f300606060405236156101255763ffffffff7c010000000000000000000000000000000000000000000000000000000060003504166306fdde03811461012a57806307da68f5146101b5578063095ea7b3146101ca57806313af40351461020057806318160ddd1461022157806323b872dd14610246578063313ce567146102825780633452f51d146102a757806369d3e20e146102e657806370a082311461030757806375f12b21146103385780637a9e5e4b1461035f5780638402181f146103805780638da5cb5b146103bf57806390bc1693146103ee57806395d89b411461040f578063a9059cbb1461049a578063be9a6555146104d0578063bf7e214f146104e5578063c47f002714610514578063dd62ed3e14610567578063e740ce261461059e575b600080fd5b341561013557600080fd5b61013d6105b3565b60405160208082528190810183818151815260200191508051906020019080838360005b8381101561017a5780820151818401525b602001610161565b50505050905090810190601f1680156101a75780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b34156101c057600080fd5b6101c8610651565b005b34156101d557600080fd5b6101ec600160a060020a03600435166024356106f0565b604051901515815260200160405180910390f35b341561020b57600080fd5b6101c8600160a060020a0360043516610774565b005b341561022c57600080fd5b6102346107f2565b60405190815260200160405180910390f35b341561025157600080fd5b6101ec600160a060020a03600435811690602435166044356107f9565b604051901515815260200160405180910390f35b341561028d57600080fd5b61023461087f565b60405190815260200160405180910390f35b34156102b257600080fd5b6101ec600160a060020a03600435166001608060020a0360243516610885565b604051901515815260200160405180910390f35b34156102f157600080fd5b6101c86001608060020a03600435166108a3565b005b341561031257600080fd5b610234600160a060020a0360043516610993565b60405190815260200160405180910390f35b341561034357600080fd5b6101ec6109b2565b604051901515815260200160405180910390f35b341561036a57600080fd5b6101c8600160a060020a03600435166109c2565b005b341561038b57600080fd5b6101ec600160a060020a03600435166001608060020a0360243516610a40565b604051901515815260200160405180910390f35b34156103ca57600080fd5b6103d2610a5f565b604051600160a060020a03909116815260200160405180910390f35b34156103f957600080fd5b6101c86001608060020a0360043516610a6e565b005b341561041a57600080fd5b61013d610b5e565b60405160208082528190810183818151815260200191508051906020019080838360005b8381101561017a5780820151818401525b602001610161565b50505050905090810190601f1680156101a75780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b34156104a557600080fd5b6101ec600160a060020a0360043516602435610bfc565b604051901515815260200160405180910390f35b34156104db57600080fd5b6101c8610c80565b005b34156104f057600080fd5b6103d2610d19565b604051600160a060020a03909116815260200160405180910390f35b341561051f57600080fd5b6101c860046024813581810190830135806020601f82018190048102016040519081016040528181529291906020840183838082843750949650610d2895505050505050565b005b341561057257600080fd5b610234600160a060020a0360043581169060243516610d5f565b60405190815260200160405180910390f35b34156105a957600080fd5b6101c8610d8c565b005b60078054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156106495780601f1061061e57610100808354040283529160200191610649565b820191906000526020600020905b81548152906001019060200180831161062c57829003601f168201915b505050505081565b61066733600035600160e060020a031916610dd7565b151561066f57fe5b600435602435808233600160a060020a031660008035600160e060020a0319169034903660405183815260406020820181815290820183905260608201848480828437820191505094505050505060405180910390a46004805474ff0000000000000000000000000000000000000000191660a060020a1790555b5b50505b565b60045460009060a060020a900460ff161561070757fe5b600435602435808233600160a060020a031660008035600160e060020a0319169034903660405183815260406020820181815290820183905260608201848480828437820191505094505050505060405180910390a46107678585610eec565b92505b5b50505b92915050565b61078a33600035600160e060020a031916610dd7565b151561079257fe5b6004805473ffffffffffffffffffffffffffffffffffffffff1916600160a060020a038381169190911791829055167fce241d7ca1f669fee44b6fc00b8eba2df3bb514eed0f6f668f8f89096e81ed9460405160405180910390a25b5b50565b6000545b90565b60045460009060a060020a900460ff161561081057fe5b600435602435808233600160a060020a031660008035600160e060020a0319169034903660405183815260406020820181815290820183905260608201848480828437820191505094505050505060405180910390a4610871868686610f59565b92505b5b50505b9392505050565b60065481565b600061089a83836001608060020a0316610bfc565b90505b92915050565b6108b933600035600160e060020a031916610dd7565b15156108c157fe5b60045460a060020a900460ff16156108d557fe5b600435602435808233600160a060020a031660008035600160e060020a0319169034903660405183815260406020820181815290820183905260608201848480828437820191505094505050505060405180910390a4600160a060020a033316600090815260016020526040902054610957906001608060020a0385166110b0565b600160a060020a03331660009081526001602052604081209190915554610987906001608060020a0385166110b0565b6000555b5b50505b5b50565b600160a060020a0381166000908152600160205260409020545b919050565b60045460a060020a900460ff1681565b6109d833600035600160e060020a031916610dd7565b15156109e057fe5b6003805473ffffffffffffffffffffffffffffffffffffffff1916600160a060020a038381169190911791829055167f1abebea81bfa2637f28358c371278fb15ede7ea8dd28d2e03b112ff6d936ada460405160405180910390a25b5b50565b600061089a8333846001608060020a03166107f9565b90505b92915050565b600454600160a060020a031681565b610a8433600035600160e060020a031916610dd7565b1515610a8c57fe5b60045460a060020a900460ff1615610aa057fe5b600435602435808233600160a060020a031660008035600160e060020a0319169034903660405183815260406020820181815290820183905260608201848480828437820191505094505050505060405180910390a4600160a060020a033316600090815260016020526040902054610b22906001608060020a0385166110c4565b600160a060020a03331660009081526001602052604081209190915554610987906001608060020a0385166110c4565b6000555b5b50505b5b50565b60058054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156106495780601f1061061e57610100808354040283529160200191610649565b820191906000526020600020905b81548152906001019060200180831161062c57829003601f168201915b505050505081565b60045460009060a060020a900460ff1615610c1357fe5b600435602435808233600160a060020a031660008035600160e060020a0319169034903660405183815260406020820181815290820183905260608201848480828437820191505094505050505060405180910390a461076785856110d8565b92505b5b50505b92915050565b610c9633600035600160e060020a031916610dd7565b1515610c9e57fe5b600435602435808233600160a060020a031660008035600160e060020a0319169034903660405183815260406020820181815290820183905260608201848480828437820191505094505050505060405180910390a46004805474ff0000000000000000000000000000000000000000191690555b5b50505b565b600354600160a060020a031681565b610d3e33600035600160e060020a031916610dd7565b1515610d4657fe5b60078180516106ea9291602001906111af565b505b5b50565b600160a060020a038083166000908152600260209081526040808320938516835292905220545b92915050565b60408051908101604052600381527f4453540000000000000000000000000000000000000000000000000000000000602082015260059080516107ee9291602001906111af565b505b565b600030600160a060020a031683600160a060020a03161415610dfb5750600161076e565b600454600160a060020a0384811691161415610e195750600161076e565b600354600160a060020a03161515610e335750600061076e565b600354600160a060020a031663b70096138430856000604051602001526040517c010000000000000000000000000000000000000000000000000000000063ffffffff8616028152600160a060020a039384166004820152919092166024820152600160e060020a03199091166044820152606401602060405180830381600087803b1515610ec157600080fd5b6102c65a03f11515610ed257600080fd5b50505060405180519050905061076e565b5b5b5b92915050565b600160a060020a03338116600081815260026020908152604080832094871680845294909152808220859055909291907f8c5be1e5ebec7d5bd14f71427d1e84f3dd0314c0f7b2291e5b200ac8c7c3b9259085905190815260200160405180910390a35060015b92915050565b600160a060020a03831660009081526001602052604081205482901015610f7c57fe5b600160a060020a038085166000908152600260209081526040808320339094168352929052205482901015610fad57fe5b600160a060020a0380851660009081526002602090815260408083203390941683529290522054610fde90836110c4565b600160a060020a03808616600081815260026020908152604080832033909516835293815283822094909455908152600190925290205461101f90836110c4565b600160a060020a03808616600090815260016020526040808220939093559085168152205461104e90836110b0565b600160a060020a03808516600081815260016020526040908190209390935591908616907fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef9085905190815260200160405180910390a35060015b9392505050565b8082018281101561076e57fe5b5b92915050565b8082038281111561076e57fe5b5b92915050565b600160a060020a033316600090815260016020526040812054829010156110fb57fe5b600160a060020a03331660009081526001602052604090205461111e90836110c4565b600160a060020a03338116600090815260016020526040808220939093559085168152205461114d90836110b0565b600160a060020a0380851660008181526001602052604090819020939093559133909116907fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef9085905190815260200160405180910390a35060015b92915050565b828054600181600116156101000203166002900490600052602060002090601f016020900481019282601f106111f057805160ff191683800117855561121d565b8280016001018555821561121d579182015b8281111561121d578251825591602001919060010190611202565b5b5061122a92915061122e565b5090565b6107f691905b8082111561122a5760008155600101611234565b5090565b905600a165627a7a723058206f02757a20e1bf8b9cbb52f86cfae8b592a2c40ee30ebecabc4a7b229923291c0029");
//        Transaction mockTx = Transaction.createContractTransaction("0xad489edb10a0f135e1cba6a3818029edaafe4a17", nonce,gasPrice, "0xa9059cbb000000000000000000000000b485d02ec713cc0df5ecdcfaefaf0e8835a40dbf0000000000000000000000000000000000000000000000008ac7230489e80000");
        EthEstimateGas estimateGas = web3j.ethEstimateGas(mockTx).sendAsync().get();
        BigInteger gas = estimateGas.getAmountUsed();
        System.out.println(gas);
    }

}
